import { Graphviz } from 'graphviz-react'
import QRCode from 'qrcode.react'

import { Image } from 'mdx-deck'

import customTheme from './theme'
export const theme = customTheme

### Hardware Wallets and the Web

##### Jon KeepKey
- email: jon@keepkey.com
- gpg: 8084908C6E1C2937
- reddit: /u/keepkeyjon

----

## What to expect

* Lesson
* Hands-on Exercises
* Follow along

----

## Follow Along

<Horizontal>

<div style="margin: 50px">
  <QRCode
    value="https://github.com/keepkeyjon/teach-hdwallet"
    size="340"
    includeMargin="true"
  />
</div>

- KeepKey, v6.1.0+
- Chrome or Brave
- Node.js 10+
- These slides!
  - https://github.com/keepkeyjon/teach-hdwallet

</Horizontal>

----

## Slides

```
$ git clone github.com/keepkeyjon/teach-hdwallet
$ cd teach-hdwallet
$ yarn
$ yarn start
```

Arrow keys to navigate.

----

### Problem

<Graphviz dot={`
  digraph D {
    "dApp A" -> "Ledger";
    "dApp C" -> "Ledger";
    "dApp B" -> "Ledger";
    "dApp B" -> "Trezor";
    "dApp C" -> "Trezor";
    "dApp D" -> "KeepKey";
  }
`} />

<Notes>
- Every vendor has their own libraries
- Fragmented wallet support
</Notes>

----

### Solution

<Graphviz dot={`
  digraph D {
    "dApp A" -> "Common API";
    "dApp B" -> "Common API";
    "dApp C" -> "Common API";
    "Common API" -> "Ledger";
    "Common API" -> "Trezor";
    "Common API" -> "KeepKey";
  }
`} />

<Notes>
- Unified api
</Notes>

----

### Solution

github.com/shapeshift/hdwallet

----

### Architecture

<Split>

<Graphviz dot={`
  digraph D {
    rankdir="LR";
    hdwalletcore [label="hdwallet-core", shape=box];
    subgraph cluster_1 {
      label = "KeepKey";
      hdwalletkeepkey [label="hdwallet-keepkey", shape=box];
      hdwalletkeepkeywebusb [label="hdwallet-keepkey-webusb", shape=box, fillcolor="aquamarine", style=filled];
      hdwalletkeepkeywebusb -> hdwalletkeepkey;
      hdwalletkeepkeynodewebusb [label="hdwallet-keepkey-nodewebusb", shape=box, fillcolor="darkseagreen1", style=filled];
      hdwalletkeepkeynodewebusb -> hdwalletkeepkey;
      hdwalletkeepkeychromeusb [label="hdwallet-keepkey-chromeusb", shape=box, fillcolor="bisque", style=filled];
      hdwalletkeepkeychromeusb -> hdwalletkeepkey;
    }
    hdwalletkeepkey -> hdwalletcore;
    subgraph cluster_2 {
      label = "Trezor"
      hdwallettrezor [label="hdwallet-trezor", shape=box];
      hdwallettrezorconnect [label="hdwallet-trezor-connect", shape=box, fillcolor="aquamarine", style=filled];
      hdwallettrezorconnect -> hdwallettrezor;
    }
    hdwallettrezor -> hdwalletcore;
    subgraph cluster_3 {
      label = "Ledger";
      hdwalletledger [label="hdwallet-ledger", shape=box];
      hdwalletledgerwebusb [label="hdwallet-ledger-webusb", shape=box, fillcolor="aquamarine", style=filled];
      hdwalletledgerwebusb -> hdwalletledger;
      hdwalletledgeru2f [label="hdwallet-ledger-u2f", shape=box, fillcolor="aquamarine", style=filled];
      hdwalletledgeru2f -> hdwalletledger;
    }
    hdwalletledger -> hdwalletcore;
  }
`} />

<Graphviz dot={`
  digraph D {
    rankdir="LR";
    subgraph cluster_0 {
      label = "Legend";
      package [label="package", shape=box];
      webpackage [label="web package", shape=box, fillcolor="aquamarine", style=filled];
      nodepackage [label="node package", shape=box, fillcolor="darkseagreen1", style=filled];
      chromepackage [label="chrome package", shape=box, fillcolor="bisque", style=filled];
    }
  }
`} />

</Split>

----

### Exercise 1: Pair Device

<iframe
  src="https://codesandbox.io/embed/github/keepkeyjon/teach-hdwallet/tree/master/exercises/01-pair-device?autoresize=1&expanddevtools=1&fontsize=14&module=%2Fsrc%2FWallet.tsx"
  title="Pair Device"
  allow="usb"
  style="width:100%; height:850px; border:0; border-radius: 4px; overflow:hidden;"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>

<Notes>
- Users should try pairing a KeepKey, or a Trezor
- May run into issues with
  - Old Firmware
  - Old Trezor Bridge versions
  - Browsers without WebUSB support
</Notes>

----

### Lesson: Feature Tests

- Coin support varies
  - Devices
  - Firmware Versions
- Support common subset 

----

### Lesson: Feature Tests

```javascript
// ETH / ETC / Ropsten / Kovan / etc.
if (supportsETH(wallet)) {
  addr = await wallet.ethGetAddress({ ... })
}

// Bitcoin / Litecoin / Dash / Doge / etc.
if (supportsBTC(wallet)) {
  addr = await wallet.btcGetAddress({ ... })
}
```

----

### Lesson: BIP32 Paths

- Standard for *derivation paths* in HD Wallets
- Notation
  - `m/44'/0'/0'/0/0`
  - `[0x8000002c, 0x80000000, 0x80000000, 0, 0]`
- BIP44 / BIP49 / BIP84

----

### Lesson: BIP32 Paths

- BIP44
  - `m/44'/0'/0'/0/0`
  - `m/purpose'/coin'/account'/change/index`

----

### Lesson: BIP32 Paths

- Problem
  - No clear standard for ETH
  - Every wallet does it differently üò≠

<br/>

Vendor | Path
-------|-------
KeepKey | `m/44'/60'/x'/0/0`
Trezor | `m/44'/60'/0'/0/x`
Ledger | `m/44'/60'/0'/x`
Ledger | `m/44'/60'/x'/0/0`
Coinomi | `m/44'/60'/x'/0`

----

### Lesson: BIP32 Paths

- Solution
  - Ask HDWallet!

```javascript
wallet.ethGetAccountPaths({
  coin: 'Ethereum',
  accountIdx: 1
})
```

----

### Lesson: Show an Address

`['üêì','ü•ö'].sort()`

```javascript
let addressNList =
  bip32ToAddressNList(`m/44'/60'/0'/0/0`)
let address = await wallet.ethGetAddress({
  coin: 'Ethereum',
  addressNList,
  showDisplay: true
  address: ???
})
```

<Notes>
TrezorConnect api requires that we provide the address that we are expecting
that the user see when it is shown on their device.

This prevents surprises, but it also means we need to have the address before
we can show it on the display.
</Notes>

----

### Lesson: Show an Address

Solution: Ask twice!

```javascript
let addressNList =
  bip32ToAddressNList(`m/44'/60'/0'/0/0`)

address = await wallet.ethGetAddress({
  coin: 'Ethereum', addressNList,
  showDisplay: false, ...msg })

renderQRCode(address)

address = await wallet.ethGetAddress({
  coin: 'Ethereum', addressNList,
  showDisplay: true, address, ...msg })
```

----

### Exercise 2: Show Address

<iframe
  src="https://codesandbox.io/embed/github/keepkeyjon/teach-hdwallet/tree/master/exercises/02-show-address?autoresize=1&expanddevtools=1&fontsize=14&module=%2Fsrc%2FWallet.tsx"
  title="Show Address"
  allow="usb"
  style="width:100%; height:850px; border:0; border-radius: 4px; overflow:hidden;"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin">
</iframe>

----

# Fin